<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Gastos - Empresa de Caminhões</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- BACKGROUND DE VÍDEO PARA A PÁGINA DE LOGIN -->
  <video autoplay muted loop playsinline id="login-video-bg">
    <source src="video/login-bg.mp4" type="video/mp4">
  </video>

  <!-- PÁGINA DE LOGIN -->
  <div id="login-page" class="page login-page page-enter">
    <div class="login-card glass-strong">
      <div class="login-header">
        <div class="logo-mark">TG</div>
        <div>
          <h1>TruckGestor</h1>
          <p>Controle de gastos da frota</p>
        </div>
      </div>

      <h2>Acessar painel</h2>
      <p class="login-subtitle">
        Faça login para cadastrar motoristas, caminhões e lançar os gastos das viagens.
      </p>

      <form id="login-form" class="form-grid">
        <div>
          <label for="login-user">Usuário</label>
          <input type="text" id="login-user" placeholder="admin" required />
        </div>

        <div>
          <label for="login-pass">Senha</label>
          <input type="password" id="login-pass" placeholder="123456" required />
        </div>

        <button type="submit" class="btn btn-primary">Entrar</button>
      </form>

      <p class="login-demo">
        <strong>Demo:</strong> usuário <code>admin</code>, senha <code>123456</code>
      </p>
    </div>
  </div>

  <!-- PÁGINA ADMIN -->
  <div id="admin-page" class="page admin-page">
    <header class="admin-header glass-strong">
      <div class="admin-brand">
        <div class="logo-mark small">TG</div>
        <div>
          <span class="brand-title">TruckGestor</span>
          <span class="brand-subtitle">Painel do administrador</span>
        </div>
      </div>
      <div class="admin-header-right">
        <nav class="admin-nav">
          <button class="nav-btn active" data-section="drivers-section">Motoristas</button>
          <button class="nav-btn" data-section="trucks-section">Caminhões</button>
          <button class="nav-btn" data-section="expenses-section">Lançar gastos</button>
          <button class="nav-btn" data-section="report-section">Relatórios</button>
        </nav>
        <button id="logout-btn" class="btn btn-secondary">Sair</button>
      </div>
    </header>

    <main class="admin-main">
      <section class="admin-intro">
        <h1>Visão geral da frota</h1>
        <p>Cadastre motoristas, controle os caminhões e registre todos os gastos em um só lugar.</p>
      </section>

      <!-- DASHBOARD: RESUMO -->
      <section class="dashboard-summary">
        <div class="summary-card glass-soft">
          <span class="summary-label">Total do mês</span>
          <span class="summary-value" id="summary-total">R$ 0,00</span>
          <span class="summary-hint" id="summary-month">—</span>
        </div>
        <div class="summary-card glass-soft">
          <span class="summary-label">Gastos lançados</span>
          <span class="summary-value" id="summary-count">0</span>
          <span class="summary-hint">lançamentos no mês</span>
        </div>
        <div class="summary-card glass-soft">
          <span class="summary-label">Motorista com maior gasto</span>
          <span class="summary-value" id="summary-top-driver">—</span>
          <span class="summary-hint" id="summary-top-driver-total">R$ 0,00</span>
        </div>
      </section>

      <!-- MOTORISTAS -->
      <section id="drivers-section" class="content-section active">
        <div class="card glass-soft">
          <div class="card-header">
            <h2>Motoristas</h2>
            <p>Cadastro simples dos motoristas que entregam as cargas.</p>
          </div>

          <form id="driver-form" class="form-grid two-cols">
            <div>
              <label for="driver-name">Nome do motorista *</label>
              <input type="text" id="driver-name" required placeholder="Ex: João da Silva" />
            </div>
            <div>
              <label for="driver-phone">Telefone</label>
              <input type="text" id="driver-phone" placeholder="(00) 00000-0000" />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Salvar motorista</button>
            </div>
          </form>
        </div>

        <div class="card glass-soft">
          <div class="card-header">
            <h3>Lista de motoristas</h3>
            <p>Visualize rapidamente quem está ativo na frota.</p>
          </div>
          <ul id="drivers-list" class="simple-list"></ul>
        </div>
      </section>

      <!-- CAMINHÕES -->
      <section id="trucks-section" class="content-section">
        <div class="card glass-soft">
          <div class="card-header">
            <h2>Caminhões</h2>
            <p>Registre os veículos para vincular os gastos à frota.</p>
          </div>

          <form id="truck-form" class="form-grid three-cols">
            <div>
              <label for="truck-plate">Placa *</label>
              <input type="text" id="truck-plate" required placeholder="Ex: ABC1D23" />
            </div>
            <div>
              <label for="truck-model">Modelo</label>
              <input type="text" id="truck-model" placeholder="Ex: Scania R450" />
            </div>
            <div>
              <label for="truck-year">Ano</label>
              <input type="number" id="truck-year" placeholder="2023" />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Salvar caminhão</button>
            </div>
          </form>
        </div>

        <div class="card glass-soft">
          <div class="card-header">
            <h3>Lista de caminhões</h3>
            <p>Placa, modelo e ano cadastrados.</p>
          </div>
          <ul id="trucks-list" class="simple-list"></ul>
        </div>
      </section>

      <!-- LANÇAMENTO DE GASTOS -->
      <section id="expenses-section" class="content-section">
        <div class="card glass-soft">
          <div class="card-header">
            <h2>Lançar gastos</h2>
            <p>Associe cada gasto ao motorista e, se quiser, ao caminhão.</p>
          </div>

          <form id="expense-form" class="form-grid three-cols">
            <div>
              <label for="expense-driver">Motorista *</label>
              <select id="expense-driver" required></select>
            </div>
            <div>
              <label for="expense-truck">Caminhão (opcional)</label>
              <select id="expense-truck">
                <option value="">Nenhum</option>
              </select>
            </div>
            <div>
              <label for="expense-category">Categoria *</label>
              <select id="expense-category" required></select>
            </div>

            <div>
              <label for="expense-date">Data *</label>
              <input type="date" id="expense-date" required />
            </div>
            <div>
              <label for="expense-value">Valor (R$) *</label>
              <input type="number" step="0.01" id="expense-value" required placeholder="0,00" />
            </div>
            <div>
              <label for="expense-invoice">Número da nota fiscal</label>
              <input type="text" id="expense-invoice" placeholder="Ex: 000123" />
            </div>

            <div>
              <label for="expense-supplier">Fornecedor</label>
              <input type="text" id="expense-supplier" placeholder="Ex: Posto BR - Rodovia" />
            </div>
            <div class="full-width">
              <label for="expense-description">Observações</label>
              <textarea id="expense-description" rows="3" placeholder="Ex: Abastecimento completo + calibragem"></textarea>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Salvar gasto</button>
            </div>
          </form>
        </div>
      </section>

      <!-- RELATÓRIO -->
      <section id="report-section" class="content-section">
        <div class="card glass-soft">
          <div class="card-header">
            <h2>Relatórios</h2>
            <p>Filtre os gastos e gere uma visão consolidada da frota.</p>
          </div>

          <form id="filter-form" class="form-grid four-cols">
            <div>
              <label for="filter-driver">Motorista</label>
              <select id="filter-driver">
                <option value="">Todos</option>
              </select>
            </div>
            <div>
              <label for="filter-truck">Caminhão</label>
              <select id="filter-truck">
                <option value="">Todos</option>
              </select>
            </div>
            <div>
              <label for="filter-category">Categoria</label>
              <select id="filter-category">
                <option value="">Todas</option>
              </select>
            </div>
            <div>
              <label for="filter-start">Data inicial</label>
              <input type="date" id="filter-start" />
            </div>
            <div>
              <label for="filter-end">Data final</label>
              <input type="date" id="filter-end" />
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-small">Aplicar filtros</button>
            </div>
          </form>

          <div class="report-summary">
            <div>
              <div class="total" id="total-display">Total: R$ 0,00</div>
              <div class="totais-motorista" id="total-by-driver"></div>
            </div>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              <button type="button" class="btn btn-secondary" onclick="exportCsv()">Exportar CSV</button>
              <button type="button" class="btn btn-secondary" onclick="window.print()">Imprimir / Salvar em PDF</button>
            </div>
          </div>

          <div class="table-wrapper glass-soft">
            <table id="expenses-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Motorista</th>
                  <th>Caminhão</th>
                  <th>Categoria</th>
                  <th>Valor (R$)</th>
                  <th>Nota Fiscal</th>
                  <th>Fornecedor</th>
                  <th>Observações</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = '';

    const loginVideo = document.getElementById('login-video-bg');
    const loginPage = document.getElementById('login-page');
    const adminPage = document.getElementById('admin-page');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');

    const navButtons = document.querySelectorAll('.nav-btn');
    const contentSections = document.querySelectorAll('.content-section');

    // começa só com login
    adminPage.style.display = 'none';
    if (loginVideo) loginVideo.style.display = 'block';

    // índice da seção atual (para slide left/right)
    let currentSectionIndex = 0; // 0 = Motoristas

    // ==== LOGIN COM ANIMAÇÃO ====
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('login-user').value;
      const password = document.getElementById('login-pass').value;

      try {
        const res = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          alert('Usuário ou senha inválidos');
          return;
        }

        // Transição login → admin
        loginPage.style.display = 'none';
        if (loginVideo) loginVideo.style.display = 'none';

        adminPage.style.display = 'flex';
        adminPage.classList.add('page-enter');
        setTimeout(() => {
          adminPage.classList.remove('page-enter');
        }, 500);

        initApp();
      } catch (err) {
        alert('Erro ao fazer login');
      }
    });

    // ==== LOGOUT COM ANIMAÇÃO ====
    function doLogout() {
      adminPage.style.display = 'none';

      if (loginVideo) loginVideo.style.display = 'block';
      loginPage.style.display = 'flex';
      loginPage.classList.add('page-enter');
      setTimeout(() => {
        loginPage.classList.remove('page-enter');
      }, 500);

      loginForm.reset();
      document.getElementById('login-user').focus();
    }

    logoutBtn.addEventListener('click', doLogout);

    // ==== NAVEGAÇÃO ENTRE SEÇÕES (SLIDE HORIZONTAL) ====
    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-section');
        const buttonsArray = Array.from(navButtons);
        const newIndex = buttonsArray.indexOf(btn);

        if (newIndex === currentSectionIndex) return; // já está na aba

        const direction = newIndex > currentSectionIndex ? 'right' : 'left';

        // alterna botões ativos
        navButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // alterna seções com slide
        contentSections.forEach(sec => {
          sec.classList.remove('slide-in-left', 'slide-in-right');

          if (sec.id === targetId) {
            sec.classList.add('active');
            void sec.offsetWidth; // reflow pra reiniciar animação
            sec.classList.add(direction === 'right' ? 'slide-in-right' : 'slide-in-left');
          } else {
            sec.classList.remove('active');
          }
        });

        currentSectionIndex = newIndex;
      });
    });

    // ==== DASHBOARD ====
    async function loadDashboard() {
      try {
        const res = await fetch(`${API_BASE}/api/dashboard`);
        if (!res.ok) return;

        const data = await res.json();

        const totalSpan = document.getElementById('summary-total');
        const monthSpan = document.getElementById('summary-month');
        const countSpan = document.getElementById('summary-count');
        const topDriverSpan = document.getElementById('summary-top-driver');
        const topDriverTotalSpan = document.getElementById('summary-top-driver-total');

        const formatMoney = (v) =>
          'R$ ' + Number(v || 0).toFixed(2).replace('.', ',');

        totalSpan.textContent = formatMoney(data.totalMonth);
        monthSpan.textContent = `Mês: ${data.month}`;
        countSpan.textContent = data.countMonth || 0;

        if (data.topDriver) {
          topDriverSpan.textContent = data.topDriver.name;
          topDriverTotalSpan.textContent = formatMoney(data.topDriver.total);
        } else {
          topDriverSpan.textContent = '—';
          topDriverTotalSpan.textContent = 'R$ 0,00';
        }
      } catch (err) {
        console.error('Erro ao carregar dashboard', err);
      }
    }

    // ==== CARREGAMENTO DE DADOS ====
    async function loadDrivers() {
      const res = await fetch(`${API_BASE}/api/drivers`);
      const drivers = await res.json();

      const list = document.getElementById('drivers-list');
      const selectExpense = document.getElementById('expense-driver');
      const selectFilter = document.getElementById('filter-driver');

      list.innerHTML = '';
      selectExpense.innerHTML = '';
      selectFilter.innerHTML = '<option value="">Todos</option>';

      drivers.forEach(d => {
        const li = document.createElement('li');
        li.textContent = d.name + (d.phone ? ` (${d.phone})` : '') + (d.active ? '' : ' (inativo)');
        list.appendChild(li);

        if (d.active) {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.name;
          selectExpense.appendChild(opt);

          const opt2 = document.createElement('option');
          opt2.value = d.id;
          opt2.textContent = d.name;
          selectFilter.appendChild(opt2);
        }
      });
    }

    async function loadTrucks() {
      const res = await fetch(`${API_BASE}/api/trucks`);
      const trucks = await res.json();

      const list = document.getElementById('trucks-list');
      const selectExpense = document.getElementById('expense-truck');
      const selectFilter = document.getElementById('filter-truck');

      list.innerHTML = '';
      selectExpense.innerHTML = '<option value="">Nenhum</option>';
      selectFilter.innerHTML = '<option value="">Todos</option>';

      trucks.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `${t.plate} ${t.model ? '- ' + t.model : ''} ${t.year ? '(' + t.year + ')' : ''}`;
        list.appendChild(li);

        if (t.active) {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.plate;
          selectExpense.appendChild(opt);

          const opt2 = document.createElement('option');
          opt2.value = t.id;
          opt2.textContent = t.plate;
          selectFilter.appendChild(opt2);
        }
      });
    }

    async function loadCategories() {
      const res = await fetch(`${API_BASE}/api/categories`);
      const categories = await res.json();

      const selectExpense = document.getElementById('expense-category');
      const selectFilter = document.getElementById('filter-category');

      selectExpense.innerHTML = '';
      selectFilter.innerHTML = '<option value="">Todas</option>';

      categories.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        selectExpense.appendChild(opt);

        const opt2 = document.createElement('option');
        opt2.value = c.id;
        opt2.textContent = c.name;
        selectFilter.appendChild(opt2);
      });
    }

    async function loadExpenses() {
      const params = new URLSearchParams();
      const filterDriver = document.getElementById('filter-driver').value;
      const filterTruck = document.getElementById('filter-truck').value;
      const filterCategory = document.getElementById('filter-category').value;
      const filterStart = document.getElementById('filter-start').value;
      const filterEnd = document.getElementById('filter-end').value;

      if (filterDriver) params.append('driver_id', filterDriver);
      if (filterTruck) params.append('truck_id', filterTruck);
      if (filterCategory) params.append('category_id', filterCategory);
      if (filterStart) params.append('start_date', filterStart);
      if (filterEnd) params.append('end_date', filterEnd);

      const res = await fetch(`${API_BASE}/api/expenses?` + params.toString());
      const data = await res.json();
      const tbody = document.querySelector('#expenses-table tbody');
      const totalDisplay = document.getElementById('total-display');
      const totalByDriverDiv = document.getElementById('total-by-driver');

      tbody.innerHTML = '';

      data.expenses.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${e.driver_name}</td>
          <td>${e.truck_plate || ''}</td>
          <td>${e.category_name}</td>
          <td>${e.value.toFixed(2)}</td>
          <td>${e.invoice_number || ''}</td>
          <td>${e.supplier || ''}</td>
          <td>${e.description || ''}</td>
        `;
        tbody.appendChild(tr);
      });

      totalDisplay.textContent = 'Total: R$ ' + data.total.toFixed(2);

      if (data.totalByDriver && data.totalByDriver.length > 0) {
        let html = '<strong>Total por motorista:</strong><ul>';
        data.totalByDriver.forEach(td => {
          html += `<li>${td.driver_name}: R$ ${td.total.toFixed(2)}</li>`;
        });
        html += '</ul>';
        totalByDriverDiv.innerHTML = html;
      } else {
        totalByDriverDiv.innerHTML = '';
      }
    }

    // ==== EXPORT CSV ====
    async function exportCsv() {
      const params = new URLSearchParams();
      const filterDriver = document.getElementById('filter-driver').value;
      const filterTruck = document.getElementById('filter-truck').value;
      const filterCategory = document.getElementById('filter-category').value;
      const filterStart = document.getElementById('filter-start').value;
      const filterEnd = document.getElementById('filter-end').value;

      if (filterDriver) params.append('driver_id', filterDriver);
      if (filterTruck) params.append('truck_id', filterTruck);
      if (filterCategory) params.append('category_id', filterCategory);
      if (filterStart) params.append('start_date', filterStart);
      if (filterEnd) params.append('end_date', filterEnd);

      try {
        const res = await fetch(`${API_BASE}/api/expenses/export?` + params.toString());
        if (!res.ok) {
          alert('Erro ao exportar CSV');
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gastos.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('Erro ao exportar CSV', err);
        alert('Erro ao exportar CSV');
      }
    }

    // ==== SUBMITS ====
    document.getElementById('driver-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('driver-name').value;
      const phone = document.getElementById('driver-phone').value;

      const res = await fetch(`${API_BASE}/api/drivers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, phone })
      });

      if (!res.ok) {
        alert('Erro ao salvar motorista');
        return;
      }

      e.target.reset();
      loadDrivers();
      loadDashboard();
    });

    document.getElementById('truck-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const plate = document.getElementById('truck-plate').value;
      const model = document.getElementById('truck-model').value;
      const year = document.getElementById('truck-year').value;

      const res = await fetch(`${API_BASE}/api/trucks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plate, model, year })
      });

      if (!res.ok) {
        alert('Erro ao salvar caminhão');
        return;
      }

      e.target.reset();
      loadTrucks();
      loadDashboard();
    });

    document.getElementById('expense-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const driver_id = document.getElementById('expense-driver').value;
      const truck_id = document.getElementById('expense-truck').value || null;
      const category_id = document.getElementById('expense-category').value;
      const date = document.getElementById('expense-date').value;
      const value = parseFloat(document.getElementById('expense-value').value);
      const invoice_number = document.getElementById('expense-invoice').value;
      const supplier = document.getElementById('expense-supplier').value;
      const description = document.getElementById('expense-description').value;

      const res = await fetch(`${API_BASE}/api/expenses`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          driver_id,
          truck_id,
          category_id,
          date,
          value,
          invoice_number,
          supplier,
          description
        })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert('Erro ao salvar gasto: ' + (err.error || ''));
        return;
      }

      e.target.reset();
      loadExpenses();
      loadDashboard();
    });

    document.getElementById('filter-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      loadExpenses();
    });

    // ==== INICIALIZAÇÃO ====
    async function initApp() {
      await loadDrivers();
      await loadTrucks();
      await loadCategories();
      await loadExpenses();
      await loadDashboard();
    }

    // ==== PARALLAX LEVE NO FUNDO ====
    window.addEventListener('scroll', () => {
      const y = window.scrollY;
      document.body.style.backgroundPositionY = `${y * -0.15}px`;
    });
  </script>
</body>
</html>
